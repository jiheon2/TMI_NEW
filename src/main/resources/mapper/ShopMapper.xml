<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- JAVA와 연결할 Mapper 파일 설정 -->
<mapper namespace="kopo.poly.persistance.mapper.IShopMapper">
    <!-- 리뷰 개수 조회 쿼리 -->
    <select id="getReviewCount"  parameterType="ShopDTO" resultType="java.lang.String">
        SELECT COUNT(*)
        FROM REVIEW
        WHERE TRADER_ID = #{traderId}
    </select>

    <!-- 예약 개수 조회 쿼리 -->
    <select id="getReserveCount"  parameterType="ShopDTO" resultType="java.lang.String">
        SELECT COUNT(*)
        FROM RESERVATION
        WHERE TRADER_ID = #{traderId}
        AND STATE = "1"
    </select>

    <!-- 당일 구매 개수 조회 쿼리 -->
    <select id="getBuyCount"  parameterType="ShopDTO" resultType="java.lang.String">
        SELECT COUNT(*)
        FROM RESERVATION
        WHERE TRADER_ID = #{traderId}
          AND DATE(RESERVATION_DATE) = CURDATE()
    </select>

    <!-- 상점 정보 조회 쿼리 -->
    <select id="getShopInfo" parameterType="ShopDTO" resultType="ShopDTO">
        SELECT SHOP_NAME, SHOP_DESCRIPTION, IMAGE, MARKET_NAME, TRADER_NAME, SHOP_NUMBER, MARKET_NUMBER
        FROM SHOP
        WHERE TRADER_ID = #{traderId}
    </select>

    <!-- 상점 정보 수정 쿼리 -->
    <update id="updateShop" parameterType="ShopDTO">
        UPDATE SHOP
        SET SHOP_DESCRIPTION = #{shopDescription},
        <if test="image neq null and image neq ''">
            IMAGE = #{image},
        </if>
            SHOP_NAME = #{shopName}
        WHERE TRADER_ID = #{traderId}
    </update>

    <!-- 상점 정보 등록 쿼리 -->
    <insert id="insertShop" parameterType="ShopDTO">
        INSERT INTO SHOP (SHOP_NAME, SHOP_DESCRIPTION, IMAGE, MARKET_NAME, TRADER_ID, TRADER_NAME, MARKET_NUMBER)
        VALUES (#{shopName}, #{shopDescription}, #{image}, #{marketName}, #{traderId}, #{traderName}, #{marketNumber})
    </insert>

    <!-- 상점 목록 조회 쿼리 -->
    <select id="getShopList" parameterType="ShopDTO" resultType="ShopDTO">
        SELECT SHOP_NUMBER, SHOP_NAME, SHOP_DESCRIPTION, IMAGE, MARKET_NAME, TRADER_ID,
               (SELECT COUNT(*) FROM SHOP WHERE MARKET_NUMBER = #{marketNumber}) AS SHOP_COUNT
        FROM SHOP
        WHERE MARKET_NUMBER = #{marketNumber}
        ORDER BY SHOP_NUMBER
    </select>

    <select id="getReserveStop"  parameterType="ShopDTO" resultType="java.lang.String">
        SELECT COUNT(*)
        FROM RESERVATION
        WHERE TRADER_ID = #{traderId}
          AND STATE = "0"
          AND DATE(RESERVATION_DATE) = CURDATE()
    </select>
</mapper>